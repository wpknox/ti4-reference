@page "/factions/{FactionId}"


@if (FactionId is null || !FactionMap.Factions.ContainsKey(FactionId))
{
    // invalid faction
    <PageTitle>Invalid Faction</PageTitle>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudText Typo="Typo.h2" Class="mb-4">Invalid Faction Name</MudText>
        <MudText Typo="Typo.body1" Class="mb-4">'@FactionId is not a faction in Twilight Imperium IV</MudText>
    </MudContainer>
    return;
}


@if (Faction is null)
{
    <PageTitle>@FactionId</PageTitle>
    <LoadingWheel />
}
else
{
    <PageTitle>@Faction.Name</PageTitle>
    <MudContainer Fixed="true">
        <MudPaper Elevation="2" Class="pa-8 ma-4" Width="100%">
            <MudText Typo="Typo.h2" Class="mb-4">@Faction.Name</MudText>
            <MudText Typo="Typo.h6"><strong>Flagship: </strong>@Faction.Flagship.Name</MudText>
            <MudText Typo="Typo.h6"><strong>Commodities: </strong>@Faction.Commodities</MudText>
            <MudDivider Class="ma-4" />
            <MudText Typo="Typo.h2" Class="mb-2">Starting Technology</MudText>
            @if (Faction.StartingTechnology is not null && Faction.StartingTechnology.Any())
            {
                <MudGrid Justify="Justify.FlexStart" Spacing="2">
                    @foreach (var startingTech in Faction.StartingTechnology ?? new())
                    {
                        <MudItem xs="6" Style="display:flex;">
                            <MudCard Elevation="4">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Style="text-decoration: underline;" Typo="Typo.h6">@startingTech.Name</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent Class="mt-n4">
                                    <MudText Typo="Typo.body1"><strong>Color: </strong>
                                        <MudText Inline="true" Style="@GetColorString(startingTech.Color)">@startingTech.Color</MudText>
                                    </MudText>
                                    @if (startingTech.Prerequisities is not null && startingTech.Prerequisities.Any())
                                    {
                                        <MudText Class="my-2" Typo="Typo.body1">
                                            <strong>Prereqs: </strong>@startingTech.Prerequisities.Join()
                                        </MudText>
                                    }
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.body1">@startingTech.Description</MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            <MudPaper Elevation="4" Class="my-4">
                <MudList Clickable="true" Color="Color.Warning" Dense="true" @bind-SelectedItem="SelectedUnitListItem">
                    <MudListSubheader Class="mb-n3"> 
                        <MudText Typo="Typo.h6" Style="text-decoration: underline;">
                            Starting Units
                        </MudText>
                    </MudListSubheader>
                    @foreach (var startingUnit in Faction.StartingUnits)
                    {
                        var unitType = startingUnit.UnitType;
                        <MudListItem Value="unitType" OnClick="@(() => GetUnitAndOpen(unitType))">
                            <MudText Typo="Typo.body2">
                                @startingUnit.UnitType - @startingUnit.Amount
                            </MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
            <MudPaper Elevation="4">
                @* planets... *@
            </MudPaper>
        </MudPaper>
    </MudContainer>
}

@* Dialog for Starting Unit *@
<MudDialog @bind-IsVisible="@IsUnitDisplayed" Options="@DialogOptions">
    <TitleContent>
        @if (SelectedUnit is null)
        {
            <MudText Typo="Typo.h6">Invalid Unit Selected</MudText>
        }
        else if(SelectedUnit! is FactionUnit factionUnit)
        {
            <MudText Typo="Typo.h6">The @(factionUnit.Faction)'s @factionUnit.Name</MudText>
        }
        else
        {
            <MudText Typo="Typo.h6">@SelectedUnit.UnitType</MudText>
        }
    </TitleContent>
    <DialogContent>
        <MudPaper Class="pa-4 mt-n4">
            @if (SelectedUnit is null)
            {
                <MudText>Unit selected is not in units.json yet</MudText>
            }
            else
            {
                <MudStack Spacing="2">
                    <MudText>Cost: @SelectedUnit.Cost</MudText>
                    <MudText>Combat Number: @SelectedUnit.CombatNumber</MudText>
                    <MudText>Hits: @SelectedUnit.Hits</MudText>
                    <MudText>Movement: @SelectedUnit.Movement</MudText>
                    <MudText>Capacity: @(SelectedUnit.Capacity is null ? "N/A" : SelectedUnit.Capacity)</MudText>
                    @if (SelectedUnit.Abilities is not null)
                    {
                        <MudText>Abilities:</MudText>
                        <MudList Class="mt-n3" DisableGutters="false" Dense="true">
                            @foreach (var ability in SelectedUnit.Abilities)
                            {
                                <MudListItem Class="my-n3">
                                    <MudText Typo="Typo.body2">
                                        @ability
                                    </MudText>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    @if (SelectedUnit.Prerequisites is not null)
                    {
                        <MudText>Prerequisites:</MudText>
                        <MudList Class="mt-n3" Dense="true">
                            <MudListItem Class="my-n3">
                                <MudText Typo="Typo.body2">
                                    @SelectedUnit.Prerequisites.Join()
                                </MudText>
                            </MudListItem>
                        </MudList>
                    }
                </MudStack>
            }
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="UnitClose" Color="Color.Primary" Variant="Variant.Filled">Close</MudButton>
    </DialogActions>
</MudDialog>